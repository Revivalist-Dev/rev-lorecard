### **System Design: AI Lorebook Generator**

#### **1. Overview**

This document outlines the architecture for an application designed to automate the creation of structured "lorebooks" and "character cards" from web-based sources. The system leverages Large Language Models (LLMs) to intelligently generate search criteria, parse web pages, extract relevant information, and summarize it into a usable format for creative writing or AI roleplaying applications. The core process is a user-guided, multi-stage workflow tailored to the type of project being created.

*   **Language:** Python
*   **Package Manager:** `uv`
*   **API framework:** Litestar
*   **Database:** SQL (SQLite and PostgreSQL). No ORM.
*   **Model validation:** Pydantic
*   **Web Scraping:** `BeautifulSoup4` for HTML parsing.
*   **Template framework:** Jinja for prompt templating.

#### **2. Core Entities & Data Models**

##### **2.1. `Project`**

*   **Purpose**: A `Project` is the primary organizational unit, representing a single generation task. It encapsulates all configuration, source data, and results for creating either one lorebook or one character card.

*   **Fields**:
    *   `id` (Text, Primary Key): A unique, human-readable identifier, derived from the project name (e.g., "skyrim-locations").
    *   `name` (Text): The user-friendly display name of the project (e.g., "Skyrim Locations Lorebook").
    *   `project_type` (Enum): The type of project, which dictates the workflow and final output (`lorebook` or `character`).
    *   `prompt` (Text, nullable): The high-level user-provided prompt to guide generation (e.g., "Skyrim locations" or "Lydia, the loyal housecarl from Skyrim").
    *   `search_params` (JSONB, nullable): For `lorebook` projects, structured search parameters generated by an LLM (`purpose`, `extraction_notes`, `criteria`).
    *   `templates` (JSONB): A structured object containing all Jinja prompt templates for the project's tasks.
        *   `selector_generation` (Text, Lorebook): The prompt used to instruct an LLM to analyze HTML and return CSS selectors.
        *   `entry_creation` (Text, Lorebook): The prompt used to instruct an LLM to process a scraped web page into a structured lorebook entry.
        *   `search_params_generation` (Text, Lorebook): The prompt used to instruct an LLM to generate search parameters from a user prompt.
        *   `character_generation` (Text, Character): The prompt used to generate a full character card from source material.
        *   `character_field_regeneration` (Text, Character): The prompt used to regenerate a single field of a character card.
    *   `credential_id` (UUID, Foreign Key, nullable): A reference to the `Credential` used for authenticating with the LLM provider.
    *   `model_name` (Text): The specific model identifier to be used for LLM calls (e.g., "google/gemini-1.5-pro-latest").
    *   `model_parameters` (JSONB): A structured object for model-specific parameters like `temperature`.
    *   `requests_per_minute` (Integer): The maximum number of API requests to make per minute for this project, used for rate limiting.
    *   `status` (Enum): The current high-level state of the project (`draft`, `search_params_generated`, `selector_generated`, `links_extracted`, `processing`, `completed`, `failed`).
    *   `created_at` (Timestamp with Timezone): The timestamp when the project was created.
    *   `updated_at` (Timestamp with Timezone): The timestamp when the project was last updated.

---

##### **2.2. `ProjectSource`**

*   **Purpose**: Represents a single web source (e.g., a wiki category page or a character profile) that can be scraped for content. A `Project` can have multiple `ProjectSource`s.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the source.
    *   `project_id` (Text, Foreign Key): Links the source to its parent `Project`.
    *   `url` (Text): The starting URL for crawling this source.
    *   `link_extraction_selector` (List of Text, nullable, Lorebook): A list of CSS selectors used to identify and extract individual article links.
    *   `link_extraction_pagination_selector` (Text, nullable, Lorebook): A single CSS selector for the 'next page' link.
    *   `max_pages_to_crawl` (Integer, Lorebook): The maximum number of pages to follow using the pagination selector.
    *   `max_crawl_depth` (Integer, Lorebook): The maximum depth of sub-categories to discover and crawl.
    *   `last_crawled_at` (Timestamp with Timezone, nullable): The timestamp of the last successful crawl.
    *   `raw_content` (Text, nullable): The cleaned, cached content scraped from the URL.
    *   `content_type` (Enum, nullable): The format of the cached content (`html` or `markdown`).
    *   `content_char_count` (Integer, nullable): The character count of the cached content.
    *   `created_at` / `updated_at` (Timestamp with Timezone): Timestamps for source lifecycle tracking.

---

##### **2.3. `ProjectSourceHierarchy`**

*   **Purpose**: Stores the hierarchical parent-child relationships between `ProjectSource`s, relevant for `lorebook` projects that discover sub-categories.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the relationship record.
    *   `project_id` (Text, Foreign Key): Links the relationship to the relevant `Project`.
    *   `parent_source_id` (UUID, Foreign Key): The ID of the parent `ProjectSource`.
    *   `child_source_id` (UUID, Foreign Key): The ID of the child `ProjectSource` discovered from the parent.
    *   `created_at` (Timestamp with Timezone): The timestamp when the relationship was established.

---

##### **2.4. `Link`**

*   **Purpose**: Represents a single URL selected by the user for processing in a `lorebook` project. Each `Link` is an atomic unit of work waiting to be processed into a `LorebookEntry`.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique, system-generated identifier for internal use.
    *   `project_id` (Text, Foreign Key): Links the `Link` to its parent `Project`.
    *   `url` (Text): The full, absolute URL of the page to be processed.
    *   `status` (Enum): The current lifecycle state (`pending`, `processing`, `completed`, `failed`, `skipped`).
    *   `error_message` (Text, nullable): Stores the error details if processing fails for this specific link.
    *   `skip_reason` (Text, nullable): Stores the reason provided by the LLM for skipping this link if it's deemed invalid.
    *   `lorebook_entry_id` (UUID, Foreign Key, nullable): A reference to the final `LorebookEntry` that was created from this link.
    *   `raw_content` (Text, nullable): The raw text content scraped from the source URL.
    *   `created_at` (Timestamp with Timezone): The timestamp when the link was extracted.

---

##### **2.5. `LorebookEntry`**

*   **Purpose**: The final, structured output of the `lorebook` generation process. It represents a single, self-contained piece of lore.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the lorebook entry.
    *   `project_id` (Text, Foreign Key): Links the entry to the `Project` it belongs to.
    *   `title` (Text): The main title of the lore entry, as generated by the LLM.
    *   `content` (Text): The summarized body of the lore entry.
    *   `keywords` (List of Text, JSONB): A list of keywords, generated by the LLM, that can be used to trigger this entry.
    *   `source_url` (Text): The original URL from which the entry's content was derived.
    *   `created_at` / `updated_at` (Timestamp with Timezone): Timestamps for entry lifecycle tracking.

---

##### **2.6. `BackgroundJob`**

*   **Purpose**: Represents a single asynchronous task executed by a background worker. This table serves as a robust, database-backed task queue.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the job.
    *   `task_name` (Enum): The name of the task to be executed (e.g., `generate_search_params`, `discover_and_crawl_sources`, `process_project_entries`, `fetch_source_content`, `generate_character_card`, `regenerate_character_field`).
    *   `payload` (JSONB, nullable): Additional arguments required for the task.
    *   `status` (Enum): The job's state (`pending`, `in_progress`, `completed`, `failed`, `cancelling`, `canceled`).
    *   `project_id` (Text, Foreign Key, nullable): Links the job to the `Project` it operates on.
    *   `created_at` / `updated_at` (Timestamp with Timezone): Timestamps for job lifecycle tracking.
    *   `result` (JSONB): The result of the job if successful.
    *   `error_message` (Text): Error details if the job failed.
    *   `total_items` / `processed_items` / `progress` (Integer/Real): Fields for tracking progress of long-running jobs.

---

##### **2.7. `ApiRequestLog`**

*   **Purpose**: An immutable audit record of every billable call made to an external LLM API, essential for cost tracking, performance analysis, and detailed debugging.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the log record.
    *   `project_id` (Text, Foreign Key): Links the request back to the project for cost aggregation.
    *   `job_id` (UUID, Foreign Key, nullable): Links the log to the `BackgroundJob` that initiated it.
    *   `api_provider` (Text): The API provider used (e.g., "openrouter").
    *   `model_used` (Text): The exact model string used for the call.
    *   `request` (JSONB): The full request payload sent to the API.
    *   `response` (JSONB, nullable): The full response payload received from the API.
    *   `input_tokens` / `output_tokens` (Integer, nullable): Token usage metrics.
    *   `calculated_cost` (Numeric, nullable): The monetary cost of the API call.
    *   `latency_ms` (Integer): The duration of the API call in milliseconds.
    *   `timestamp` (Timestamp with Timezone): The exact time the request was made.
    *   `error` (Boolean): A flag indicating if the API call resulted in an error.

---

##### **2.8. `Credential`**

*   **Purpose**: Securely stores encrypted authentication details (e.g., API keys, base URLs) for various LLM providers.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the credential.
    *   `name` (Text, Unique): A user-friendly name for the credential (e.g., "My Personal OpenRouter Key").
    *   `provider_type` (Text): The identifier of the provider this credential is for (e.g., "openrouter", "gemini", "openai_compatible").
    *   `values` (Text): An encrypted JSON string containing the actual secrets, such as `api_key` and `base_url`.
    *   `created_at` / `updated_at` (Timestamp with Timezone): Timestamps for credential lifecycle tracking.

---

##### **2.9. `GlobalTemplate`**

*   **Purpose**: Stores reusable Jinja prompt templates that can be referenced by any `Project`.

*   **Fields**:
    *   `id` (Text, Primary Key): A unique, human-readable identifier for the template (e.g., "default-selector-prompt").
    *   `name` (Text, Unique): A user-friendly, unique name for the template (e.g., "Default Selector Prompt").
    *   `content` (Text): The full Jinja template string.
    *   `created_at` / `updated_at` (Timestamp with Timezone): Timestamps for template lifecycle tracking.

---

##### **2.10. `CharacterCard`**

*   **Purpose**: A dedicated table to store the structured data for a single character, linked one-to-one with a `character` type project. This format is compatible with common AI roleplaying frontends.

*   **Fields**:
    *   `id` (UUID, Primary Key): A unique identifier for the character card.
    *   `project_id` (Text, Foreign Key, Unique): Links the card to its parent `Project`.
    *   `name` (Text, nullable): The character's name.
    *   `description` (Text, nullable): Physical and general description.
    *   `persona` (Text, nullable): Personality, demeanor, and inner thoughts.
    *   `scenario` (Text, nullable): The setting or scenario the character is in.
    *   `first_message` (Text, nullable): The character's opening message in a roleplay.
    *   `example_messages` (Text, nullable): Formatted dialogue examples to guide the AI's speech patterns.
    *   `created_at` / `updated_at` (Timestamp with Timezone): Timestamps for card lifecycle tracking.

---

##### **2.11. Database Schema & Relationships**

*   **Relationships**:
    *   `Project.credential_id` -> `Credential.id` (Many-to-One, nullable). `ON DELETE SET NULL`.
    *   `ProjectSource.project_id` -> `Project.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `ProjectSourceHierarchy.project_id` -> `Project.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `ProjectSourceHierarchy.parent_source_id` -> `ProjectSource.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `ProjectSourceHierarchy.child_source_id` -> `ProjectSource.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `Link.project_id` -> `Project.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `LorebookEntry.project_id` -> `Project.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `Link.lorebook_entry_id` -> `LorebookEntry.id` (One-to-One, nullable). `ON DELETE SET NULL`.
    *   `CharacterCard.project_id` -> `Project.id` (One-to-One). `ON DELETE CASCADE`.
    *   `BackgroundJob.project_id` -> `Project.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `ApiRequestLog.project_id` -> `Project.id` (Many-to-One). `ON DELETE CASCADE`.
    *   `ApiRequestLog.job_id` -> `BackgroundJob.id` (Many-to-One). `ON DELETE SET NULL`.

*   **Indexing Strategy**:
    *   `Project`: `id` (PK), `credential_id`, `project_type`.
    *   `Credential`: `id` (PK), `provider_type`. Unique on `name`.
    *   `ProjectSource`: `project_id`. Unique on `(project_id, url)`.
    *   `ProjectSourceHierarchy`: `project_id`, `parent_source_id`, `child_source_id`. Unique on `(parent_source_id, child_source_id)`.
    *   `Link`: `(project_id, status)`. Unique on `(project_id, url)`.
    *   `LorebookEntry`: `project_id`.
    *   `CharacterCard`: `project_id` (Unique).
    *   `BackgroundJob`: `(status, created_at)`.
    *   `ApiRequestLog`: `project_id`.
    *   `GlobalTemplate`: `id` (PK). Unique on `name`.

### **3. Core Workflows**

The application's functionality is driven by distinct, user-initiated workflows, managed by background jobs.

#### **General LLM Interaction Step**
All workflows requiring LLM communication follow this procedure:
1.  **Retrieve Project Configuration**: Fetch the `Project` associated with the job.
2.  **Fetch & Decrypt Credential**: Retrieve the linked `Credential` and decrypt its `values`.
3.  **Instantiate Provider**: Instantiate the correct provider client (e.g., "openrouter") using the decrypted secrets.
4.  **Execute & Log API Call**: Make the API request and create an `ApiRequestLog` record.

---

##### **3.1. Workflow A: [Lorebook] Project Setup & Search Parameter Generation**
*Identical to original design: User creates a `lorebook` project, provides a prompt, and a `generate_search_params` job is run to populate `Project.search_params`.*

---

##### **3.2. Workflow B: [Lorebook] Source Discovery & Crawling**
*Identical to original design: A `discover_and_crawl_sources` job is run on selected sources. It uses an LLM to find CSS selectors, then crawls the sources for content and category links, creating new `ProjectSource` records for sub-categories.*

---

##### **3.3. Workflow C: [Lorebook] Link Confirmation**
*Identical to original design: A `confirm_links` job takes a user-approved list of URLs and creates `Link` records in the database with `status: 'pending'`.*

---

##### **3.4. Workflow D: [Lorebook] Entry Generation**
*Identical to original design: A `process_project_entries` job iterates through processable `Link` records, scrapes content, uses an LLM with the `entry_creation` template to generate a `LorebookEntry`, and updates the statuses.*

---

##### **3.5. Workflow E: Character Card Generation**

This workflow is used for projects with `project_type: 'character'`.

1.  **Project & Source Setup**: A user creates a new `Project` of type `character`, providing a prompt, credential, and model. They then add one or more `ProjectSource`s, where each URL points to a page with information about the character.
2.  **Content Fetching**:
    *   **Job Invocation**: The user selects sources and initiates the content fetching step, creating a `BackgroundJob` with `task_name: 'fetch_source_content'`.
    *   **Worker Execution**: A worker scrapes each source URL, cleans the HTML, converts it to Markdown, and caches the result in the `ProjectSource.raw_content` field. This step does not involve an LLM.
3.  **Initial Card Generation**:
    *   **Job Invocation**: The user initiates generation, creating a `BackgroundJob` with `task_name: 'generate_character_card'`. The payload can contain specific `source_ids` to use.
    *   **Worker Execution**: The worker aggregates the cached `raw_content` from the selected sources. It follows the **General LLM Interaction Step**, using the `templates.character_generation` prompt and the aggregated content. It expects a structured JSON response matching the `CharacterCardData` schema. Upon success, it creates or updates the `CharacterCard` record linked to the project and sets the `Project.status` to `completed`.
4.  **Field Regeneration (Optional)**:
    *   **Job Invocation**: The user can choose to regenerate a single field (e.g., `description`). This creates a `BackgroundJob` with `task_name: 'regenerate_character_field'` and a payload specifying the field, a custom prompt, and context options.
    *   **Worker Execution**: The worker gathers context (other card fields, source material), follows the **General LLM Interaction Step** with the `templates.character_field_regeneration` prompt, and updates only the specified field in the `CharacterCard` record.

#### **4. API Endpoints**

*   **Projects**
    *   `POST /projects`: Create a new project.
    *   `GET /projects`: List all projects.
    *   `GET /projects/{project_id}`: Retrieve a single project's details.
    *   `PATCH /projects/{project_id}`: Update a project.
    *   `DELETE /projects/{project_id}`: Delete a project.
    *   `GET /projects/{project_id}/links`: Get a paginated list of links for the project.
    *   `GET /projects/{project_id}/links/processable-count`: Get the count of pending/failed links.
    *   `GET /projects/{project_id}/entries`: Get a paginated list of generated lorebook entries.
    *   `GET /projects/{project_id}/logs`: Get a paginated list of API request logs for the project.
    *   `GET /projects/{project_id}/lorebook/download`: Get the lorebook in a downloadable format.

*   **Credentials**
    *   `POST /credentials`: Create a new credential.
    *   `GET /credentials`: List all credentials.
    *   `GET /credentials/{credential_id}`: Retrieve a single credential.
    *   `PATCH /credentials/{credential_id}`: Update a credential.
    *   `DELETE /credentials/{credential_id}`: Delete a credential.

*   **Project Sources**
    *   `GET /projects/{project_id}/sources`: List all sources for a project.
    *   `POST /projects/{project_id}/sources`: Add a new source to a project.
    *   `GET /projects/{project_id}/sources/hierarchy`: Get the parent-child relationships between sources.
    *   `POST /projects/{project_id}/sources/test-selectors`: Tests CSS selectors against a URL for a real-time preview.
    *   `PATCH /projects/{project_id}/sources/{source_id}`: Update a source.
    *   `DELETE /projects/{project_id}/sources/{source_id}`: Delete a source.
    *   `POST /projects/{project_id}/sources/delete-bulk`: Delete multiple sources in one request.

*   **Links**
    *   `POST /projects/{project_id}/links/delete-bulk`: Deletes multiple links for a project in a single request.

*   **Lorebook Entries**
    *   `GET /entries/{entry_id}`: Retrieve a single lorebook entry.
    *   `PUT /entries/{entry_id}`: Manually edit a generated lorebook entry.
    *   `DELETE /entries/{entry_id}`: Delete a lorebook entry.

*   **Character Card**
    *   `GET /projects/{project_id}/character`: Get the character card for a project.
    *   `PATCH /projects/{project_id}/character`: Create or update the character card.
    *   `GET /projects/{project_id}/character/export`: Export the card as a v2 PNG file.

*   **Background Jobs**
    *   `GET /jobs`: List all background jobs.
    *   `GET /jobs/{job_id}`: Retrieve a single job's status and progress.
    *   `GET /jobs/latest`: Get the latest job for a project by task name.
    *   `POST /jobs/generate-search-params`: Create a job to generate search parameters (Lorebook).
    *   `POST /jobs/discover-and-crawl`: Create a job to discover and crawl sources for links (Lorebook).
    *   `POST /jobs/confirm-links`: Create a job to ingest a user-confirmed list of URLs (Lorebook).
    *   `POST /jobs/process-project-entries`: Create a job to process links into lorebook entries (Lorebook).
    *   `POST /jobs/rescan-links`: Create a job to re-crawl sources using existing selectors (Lorebook).
    *   `POST /jobs/fetch-content`: Create a job to fetch and cache content for sources (Character).
    *   `POST /jobs/generate-character`: Create a job to generate a full character card (Character).
    *   `POST /jobs/regenerate-field`: Create a job to regenerate a single field of a character card (Character).
    *   `POST /jobs/{job_id}/cancel`: Request cancellation of a running job.

*   **Providers**
    *   `GET /providers`: List all available AI providers and their models.
    *   `POST /providers/test`: Test a credential configuration against a provider.
    *   `POST /providers/models`: Dynamically fetch models from a provider using given credentials.

*   **Server-Sent Events (SSE)**
    *   `GET /sse/subscribe/{project_id}`: Subscribe to a stream of real-time events for a project.

*   **Analytics**
    *   `GET /analytics/projects/{project_id}`: Get aggregated cost and usage statistics for a project.

*   **Global Templates**
    *   `POST /global-templates`: Create a new global template.
    *   `GET /global-templates`: List all global templates.
    *   `GET /global-templates/{template_id}`: Retrieve a single global template.
    *   `PATCH /global-templates/{template_id}`: Update a global template.
    *   `DELETE /global-templates/{template_id}`: Delete a global template.